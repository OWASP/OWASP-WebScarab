<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="all" name="webscarab">
        <target name="init">
                <tstamp/>
                <property file="local.properties"/>
                <property name="project.version" value="${DSTAMP}-${TSTAMP}"/>
                <property name="build.dir" location="${basedir}/build"/>
                <property name="src.dir" location="${basedir}/src"/>
                <property name="dist.dir" location="${basedir}/dist"/>
                <property name="javadoc.dir" location="${basedir}/doc/api"/>
                <property name="project.name" value="${ant.project.name}"/>
                <property name="jar" location="${basedir}/${project.name}.jar"/>
                
                <property name="mainclass" value="org.owasp.webscarab.ui.swing.Main"/>
                
             	<property name="concurrentjar" value="lib/concurrent.jar"/>
             	<property name="htmlparserjar" value="lib/htmlparser.jar"/>
             	<property name="bsfjar" value="lib/bsf-2.3.0.jar"/>
             	<property name="beanshelljar" value="lib/bsh-2.0b1.jar"/>
             	<property name="jfreechartjar" value="lib/jfreechart-0.9.12.jar"/>
             	<property name="jcommonjar" value="lib/jcommon-0.8.7.jar"/>
             	<property name="jhelpjar" value="lib/jhall-2.0_02.jar"/>
             	<property name="chardetjar" value="lib/chardet.jar"/>
             	<property name="tagsoupjar" value="lib/tagsoup-1.0rc2.jar"/>
                
                <path id="cpath">
			<pathelement location="${build.dir}"/>
			<pathelement path="${concurrentjar}"/>
                        <pathelement path="${htmlparserjar}"/>
			<pathelement location="${bsfjar}"/>
			<pathelement location="${beanshelljar}"/>
			<pathelement location="${jfreechartjar}"/>
			<pathelement location="${jcommonjar}"/>
			<pathelement location="${jhelpjar}"/>
			<pathelement location="${chardetjar}"/>
			<pathelement location="${tagsoupjar}"/>
		</path>
	</target>
	<target depends="init" description="clean up the build area" name="clean">
		<delete dir="${build.dir}"/>
		<delete dir="${dist.dir}"/>
                <delete>
                    <fileset dir="${src.dir}" includes="**/*.class"/>
                </delete>
                <mkdir dir="${build.dir}"/>
                <mkdir dir="${dist.dir}"/>
                <delete>
                    <fileset dir="${basedir}" includes="webscarab*.jar"/>
                    <fileset dir="${basedir}" includes="webscarab*.zip"/>
                </delete>
	</target>
	<target depends="init" description="prepare the build area" name="prepare">
                <copy file="server.p12" todir="${build.dir}"/>
                <copy file="src/org/owasp/webscarab/plugin/scripted/script.bsh" todir="${build.dir}/org/owasp/webscarab/plugin/scripted/"/>
	</target>
	<target depends="prepare" description="Compile the sources" name="compile">
		<javac classpathref="cpath" deprecation="yes" destdir="${build.dir}" excludes="**/test/**" listfiles="yes" optimize="on" srcdir="${src.dir}">
                </javac>
	</target>
        <target name="setproxy" if="http.proxyHost">
            <echo>Setting proxy</echo>
	    <setproxy proxyhost="${http.proxyHost}" proxyport="${http.proxyPort}"/>
        </target>
        <target depends="prepare,setproxy" description="JavaHelp" name="javahelp">
            <xslt basedir="doc/userguide/" destdir="${build.dir}/help" scanincludeddirectories="false" includes="swing.xml" style="${javahelpstyle}"/>
            <copy todir="${build.dir}/help/">
                <fileset dir="doc/userguide/" includes="*.png,*.jpg,*.gif"/>
            </copy>
        </target>
	<target depends="compile,javahelp" description="Build a jar file" name="build">
		<jar basedir="${build.dir}" jarfile="${jar}">
                    <manifest>
                        <attribute name="Main-Class" value="${mainclass}"/>
                        <attribute name="Class-Path" value="${concurrentjar} ${htmlparserjar} ${beanshelljar} ${jfreechartjar} ${jcommonjar} ${bsfjar} ${jhelpjar} ${chardetjar} ${tagsoupjar}"/>
                        <!-- <attribute name="Built-By" value="${user.name}"/> -->
                        <section name="common">
                            <attribute name="Implementation-Title" value="common"/>
                            <attribute name="Implementation-Version" value="${project.version}"/>
                            <attribute name="Implementation-Vendor" value="OWASP Foundation."/>
                        </section>
                    </manifest>
                </jar>
	</target>
	<target depends="build" description="run the program" name="run">
		<java jar="${jar}" fork="on">
		</java>
	</target>
        <target depends="init" description="JavaDoc" name="javadoc">
            <mkdir dir="${javadoc.dir}"/>
            <javadoc classpathref="cpath" destdir="${dist.dir}/doc/" packagenames="*">
                <sourcepath>
                    <pathelement location="${src.dir}"/>
                </sourcepath>
            </javadoc>
        </target>
    <!-- ${basedir}/izpack should contain the expanded IzPack distribution
      == as created by the IzPack installer. It could be a link to the real
      == directory, etc. 
      == IzPack is available from http://www.izforge.com/izpack/
      -->
	<target depends="clean,build" description="Build a self contained installer package" name="izpack">
                <taskdef classname="com.izforge.izpack.ant.IzPackTask" classpath="${basedir}/izpack/lib/compiler.jar" name="izpack"/>
		<izpack basedir="${basedir}" input="${basedir}/installer/izpack.xml" installerType="standard" izPackDir="${basedir}/izpack/" output="${dist.dir}/webscarab-installer-${project.version}.jar"/>
	</target>
    <!-- ${basedir}/proguard should contain the expanded proguard distribution
      == It could just be a link to the real directory, etc. 
      == ProGuard is available from http://proguard.sourceforge.net/
      == Unfortunately, at this time, the configuration file is heavily
      == tied to a specific desktop, and installation directories
      -->
        <target depends="clean,build" description="Build a standalone self-contained jar" name="proguard">
            <taskdef classpath="${basedir}/proguard/lib/proguard.jar" resource="proguard/ant/task.properties"/>
            <proguard ignorewarnings="true" obfuscate="false" optimize="true" verbose="true">
                <injar name="${jar}"/>
                <injar name="${basedir}/${concurrentjar}"/>
                <injar name="${basedir}/${htmlparserjar}"/>
                <injar name="${basedir}/${beanshelljar}"/>
                <injar name="${basedir}/${bsfjar}"/>
                <injar name="${basedir}/${jfreechartjar}"/>
                <injar name="${basedir}/${jcommonjar}"/>
                <injar name="${basedir}/${chardetjar}"/>
                <injar name="${basedir}/${tagsoupjar}"/>
                <libraryjar name="${basedir}/${jhelpjar}"/>
		<libraryjar name="${java.home}/lib/rt.jar"/>
		<libraryjar name="${java.home}/lib/jsse.jar"/>
                <outjar name="${dist.dir}/webscarab-selfcontained-${project.version}.jar"/>
                <keep name="${mainclass}">
                    <method name="main"/>
                </keep>
                <keep implements="org.owasp.webscarab.ui.swing.editors.ByteArrayEditor"/>
                <keep implements="org.apache.bsf.BSFEngine"/>
                <keep name="org.owasp.webscarab.*" access="public"/>
            </proguard>
        </target>
        <target depends="init,clean" description="packages up the source files" name="source">
            <zip destfile="${dist.dir}/webscarab-src-${project.version}.zip">
                <zipfileset dir="${basedir}" includes="ChangeLog" prefix="webscarab-${project.version}"/>
                <zipfileset dir="${basedir}" includes="LICENSE" prefix="webscarab-${project.version}"/>
                <zipfileset dir="${basedir}" includes="README" prefix="webscarab-${project.version}"/>
                <zipfileset dir="${basedir}" includes="INSTALL" prefix="webscarab-${project.version}"/>
                <zipfileset dir="${basedir}" includes="build.xml" prefix="webscarab-${project.version}"/>
                <zipfileset dir="${src.dir}" excludes="**/.*" prefix="webscarab-${project.version}/src"/>
            </zip>
        </target>
        <target depends="clean,source,proguard,izpack" description="Build all distributables" name="dist"/>
</project>
